### 关于 wx-tmy-prompt

本项目由微信公众号 “填密语” 官方提供，主要用来定义填密语公众号对接 chatGPT 聊天室的 prompt 规格。

填密语公众号是一个多聊天室机器人问答系统，公众号里设置多个房间（room），不同房间提供不同主题的问答服务。本项目定义聊天室 room 的规格，一个 room 中可定义多个触发词 magics，每个触发词都对应一项动作，动作包含用于 chatGPT 聊天的 prompt 定义。

&nbsp;

### 快速入门

第一步：关注微信公众号 “填密语”，可以在微信中搜索找到。关注成功后，系统会自动为您创建两个房间：“GPT” 与 “翻译”，在公众号中点 “主页” 及 “配置” 按钮系统将跳到相关页指导初学者如何使用本工具。

第二步：进入本公众号的 “GPT” 房间，将如下二维码拍照（如果当前您正用手机访问本网页，将下面二维码截屏），然后把照片或截屏图片在公众号中发送。公众号随即自动导入一个 room 定义。

（图片）

第三步，在公众号中输入 "？"，您将发现 “可换房间” 列表多了一项 “工具房” ，切换到工具房后，输入 "天气"，chatGPT 将反馈当前您指定城市的天气信息。

上面扫二维码实质是将本项目的 "sample_prompt_v1.json" 文件地址告诉公众号，这个 json 文件正是工具房的 room 定义。

&nbsp;

### 自定义聊天室

下文介绍如何自定义一间可在填密语公众号中使用的聊天室，拿上面介绍的工具房举例。

先讲最简情形，比方，如何查询深圳当前天气，定义 room 如下：

``` json
{
  "room_ver": 1,
  "room_desc": "工具房",
  
  "magic_rules": {
    "天气":["*"]
  },
  "prompts": {
    "天气":{"ask":"帮我查一下当前 深圳 的天气。"}
  },
  "magics": ["天气"]
}
```

这里，room_ver 是填密语公众号要求的 room 规格版本号，当前固定填 1，以后若有更高版本规格推出，可以改填 "2, 3" 等，所有官方发布的历代 room_ver 版本号，在本公众号都会一直兼容下去。

room_desc 是聊天室名称，输入类似 "换房间 工具房" 指令时，room_desc 会用到。

magic_rules 定义聊天指令触发词，与机器人正常聊天时不会孤立的输入触发词，触发词就像一句魔咒，你喊一声，咒语匹配后，机器人就会执行你指定的命令。上面例子中，我们定义了一个触发词 "天气"，触发后，系统就会执行在 prompt 预定义的一句问话，如 "帮我查一下当前 深圳 的天气。"。

在 magic_rules 中定义触发词都有捕获触发能力，但并不是所有触发词都在用户输入 "?" 后打印帮助信息中显示，只有在 magics 列表项中指定触发词才打印。所以，在 room 定义中，magic_rules 项目个数可能多于在 magics 中指定的，这意味着，提供 room 定义的作者，可以有意隐藏某些触发词的，隐藏的触发词就真成咒语了，修成大法才念得出来。

上面 magic_rules 定义 "天气" 时列出 "*"，表明对应 prompt 问话被触发时，问话尾部将自动附加输入的描述。比如，用户输入："天气 今起三天"，GPT 将按 “帮我查一下当前 深圳 的天气。今起三天” 响应。

&nbsp;

### 给 room 增加变量定义

上例把被查询的城市固定写死在 prompt 中不是好主意，因为相同 prompt 会交给不同用户使用，用户可能分布在多个城市，或者，用户可能要到外地出差、旅游什么的。我们应该将 prompt 中的城市名称抽像定义成一个变量，比方叫 "locations"，优化后的 room 定义如下：

``` json
{
  "room_ver": 1,
  "room_desc": "工具房",
  
  "globals": {"locations":["深圳"]},
  "magic_rules": {
    "关注":[["城市名","include","{locations}"]],
    "移除":[["城市名","exclude","{locations}"]],
    "天气":["*"]
  },
  "prompts": {
    "天气":{"ask":"帮我查一下 {locations} 的天气，简短些。"}
  },
  "magics": ["天气","关注","移除"]
}
```

我们增加全局域名空间 globals 定义，如上 `globals["locations"]` 表达城市列表，在 magic_rules 中定义 "关注" 触发词用于往该列表添加城市名，定义 "移除" 用于将指定城市移出列表。

magic_rules 定义了 3 个触发词的规格，所以用户在公众号中输入 "?" 时，系统将打印如下帮助信息：

```
当前指令：
  天气 *
  关注 城市名
  移除 城市名
```

然后在 prompt 的 ask 定义中用 "{locations}" 引用这个变量。

这样，在公众号中输入 "关注 上海" 后，再输入 "天气" 触发词，prompt 中的 ask 将变成 "帮我查一下 深圳、上海 的天气，简短些。"。如果执行 "移除 深圳" 后，再触发 "天气"，ask 字中变成 "帮我查一下 上海 的天气，简短些。"。

说明，上面 magic_rules 中 "include" 含义是：将用户输入 "城市" 名包含到 locations 变量中，类似的，"exclude" 含义移除指定的 "城市" 名。除了 include 与 exclude，针对列表类型的变量，还有 clear 操作，用于清空列表。

&nbsp;

### 增加局部变量

上面在 globals 中定义的是全局变量，全局变量有变化时，公众号后台服务器自动保存更改。除了全局变量，我们的 room 定义还支持局部变量，未显式在 globals 列表中申明就使用的变量，是局部变量，局部变量只在一次触发词触发，或 prompt 使用时起作用，用完立即失效。

我们换个例子：询问地铁线路，如下。

``` json
{
  "room_ver": 1,
  "room_desc": "工具房",
  
  "context_size": 1,
  "max_token": 600,
  "system_role": "你是一个友善的助手",
  
  "globals": {"locations":["深圳"]},
  "magic_rules": {
    "关注":[["城市名","include","{locations}"]],
    "移除":[["城市名","exclude","{locations}"]],
    "天气":["*"],
    "地铁":[["出发位置","set","from"],["目标位置","set","to"],"*"]
  },
  "prompts": {
    "天气":{"ask":"帮我查一下 {locations} 的天气，简短些。"},
    "地铁":{"ask":"我在关注 {locations} 城市，请问从 {from} 到 {to} 如何坐地铁？","context_size":3}
  },
  "magics": ["天气","地铁","关注","移除"]
}
```

这里，"地铁" 触发词对应的 prompt 中用到 `{locations}, {from}, {to}` 共 3 个变量，凡在 globals 列表中能找到的是全局变量，找不到是局部变量。当用户在公众号中输入 "地铁 南头中学 皇岗口岸" 后，局变量量 `{from}, {to}` 将分别被赋值，作用到 prompt 定义，生成的问句便是："我在关注 深圳 城市，请问从 南头中学 到 皇岗口岸 如何坐地铁？"。

如上，对于字串类型的变量，赋值要用 set 指令。

在这个例子中，我们还用到 context_size 配置，它用来指示一次问答时，问句需要携带多少个历史问答，定义 context_size 为 1，表示 1 次问答（即，最近的一问一答）。在询问地铁线路时，我们希望像正常聊天一样，向机器人多问几个问题，携带历史问答多些，机器人答复就更精确些，所以，在 "地铁" 触发词对应的 prompt 定义中，我们指定 context_size 为 3，这样保证用户询问地铁如何搭乘后，可以随后多问一些问题，比如，有没有公交接驳什么的。

&nbsp;

### 其它配置项

接下来，我们补充介绍剩下的配置项。

填密语公众号后台为每个 room 配置一个只读全局量 `{LASK_ASK}`，如果 keep_last_ask 配置项打开（即取值 true），这个只读全局量就会生效，反之不生效。LASK_ASK 变量由系统自动记录最近一次问句，用户在 prompt 中可以引用这个变量，但无法改写它。

下面我们给出 room 定义例子（为阅读方便，我们没写全）。

``` json
{
  "room_ver": 1,
  "room_desc": "工具房",

  "context_size": 1,
  "max_token": 600,
  "system_role": "你是一个友善的助手",
  "fixed_messages": [],
  "start_messages": [],
  
  "keep_last_ask": true,
  "only_magic": true,
  "globals": {"locations":["深圳"],"last_ask":"{LAST_ASK}"},
  "prompts": {
    "继续":{"ask":"{last_ask}"}
  },
  "state_desc": "{locations}"
}
```

我们在 globals 定义了 last_ask 变量，用于取得 LAST_ASK 只读变量的值。然后，在 "继续" 触发词的 prompt 中引用这个 lask_ask，就自动获得最近一次用户提问。

当用户高频使用某一个触发词，比方查 “天气”，引用 LAST_ASK 会很有用，像这个例子，"继续" 一词用 "，" 代替是系统内置支持的，每天查一次天气，就简化到只需输入一个逗号。

另外，only_magic 配置项如果取 true，表示非触发词启动的问句将被忽略，启动与机器人聊天后，一问一答才可持续进行（如果中间停上一段时间会话将自动终止）。如果 only_magic 取 false 值，当前 room 表现得像聊天室，任何时候都可以启动一问一答交流，否则，only_magic 取 true，表示当前 room 更像一个工具集，不适合用作聊天。

state_desc 配置用于描述 room 的在线状态，以便用户输入 "？" 查询时，打印信息能更明确的指示当前 room 所处的状态。上面代码将显示 "{深圳}"，提示当前用户所处的城市。

上面，fixed_messages 配置用于在每次发出提问时，都前置插入若干次问答，比如：

```
  "fixed_messages": [{"ask":"question1...","answer":"answer1..."}]
```

start_messages 配置用于一个新会话刚启动时，自动插入若干次问答，比如：

```
  "start_messages": [{"ask":"question1...","answer":"answer1..."}]
```

start_messages 用于自动出示若干样例（让 AI 快速代入场景），随着聊天进展，后续问答会挤掉这个样例，而 fixed_messages 样例则是永不被挤占的设计。

说明，fixed_messages 与 start_messages 的功效与 prompt 有点接近，但 prompt 只定义提问句式，没给出一问一答的范例。

&nbsp;
